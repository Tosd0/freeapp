<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key状态管理测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background-color: #f5f5f7;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .key-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .key-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .key-status-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .test-btn {
            padding: 8px 16px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .status-log {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007aff; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Key状态管理测试</h1>
        
        <div class="test-section">
            <div class="test-title">主Key状态测试</div>
            <div class="key-row">
                <input type="password" class="key-input" id="mainKey" placeholder="主API Key" value="sk-test-main-key-123456">
                <button class="key-status-btn main-key-status" data-status="enabled" data-enabled="true" onclick="testMainKeyToggle(this)" title="主Key(已启用)">🟢</button>
                <button class="test-btn" onclick="testMarkMainKeyFailed()">标记失败</button>
                <button class="test-btn" onclick="resetMainKey()">重置</button>
            </div>
            <div id="mainKeyStatus" class="status-log"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">副Key状态测试</div>
            <div class="key-row">
                <input type="password" class="key-input" placeholder="副API Key 1" value="sk-test-secondary-key-1">
                <button class="key-status-btn" data-status="disabled" data-enabled="false" onclick="testSecondaryKeyToggle(this)" title="副Key(未启用)">⚪</button>
            </div>
            <div class="key-row">
                <input type="password" class="key-input" placeholder="副API Key 2" value="sk-test-secondary-key-2">
                <button class="key-status-btn" data-status="disabled" data-enabled="false" onclick="testSecondaryKeyToggle(this)" title="副Key(未启用)">⚪</button>
            </div>
            <div id="secondaryKeyStatus" class="status-log"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">测试用例</div>
            <button class="test-btn" onclick="runAllTests()">运行所有测试</button>
            <button class="test-btn" onclick="clearLogs()">清空日志</button>
            <div id="testLog" class="status-log"></div>
        </div>
    </div>

    <script>
        // 日志函数
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // 测试主Key切换
        function testMainKeyToggle(button) {
            const currentStatus = button.dataset.status;
            log('mainKeyStatus', `主Key状态切换: ${currentStatus}`, 'info');
            
            // 模拟三态切换逻辑
            switch (currentStatus) {
                case 'enabled':
                    button.dataset.status = 'failed';
                    button.dataset.enabled = 'false';
                    button.style.backgroundColor = '#dc3545';
                    button.textContent = '🔴';
                    button.title = '主Key标记失败 (点击重新启用)';
                    log('mainKeyStatus', '主Key: 启用 → 失败', 'error');
                    break;
                case 'failed':
                    button.dataset.status = 'enabled';
                    button.dataset.enabled = 'true';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = '🟢';
                    button.title = '主Key已启用 (点击设为失败)';
                    log('mainKeyStatus', '主Key: 失败 → 启用', 'success');
                    break;
                case 'disabled':
                    button.dataset.status = 'enabled';
                    button.dataset.enabled = 'true';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = '🟢';
                    button.title = '主Key已启用 (点击设为失败)';
                    log('mainKeyStatus', '主Key: 禁用 → 启用', 'success');
                    break;
            }
        }

        // 测试副Key切换
        function testSecondaryKeyToggle(button) {
            const currentStatus = button.dataset.status;
            log('secondaryKeyStatus', `副Key状态切换: ${currentStatus}`, 'info');
            
            switch (currentStatus) {
                case 'disabled':
                    button.dataset.status = 'enabled';
                    button.dataset.enabled = 'true';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = '🟢';
                    button.title = '副Key已启用 (点击禁用)';
                    log('secondaryKeyStatus', '副Key: 禁用 → 启用', 'success');
                    // 禁用其他副Key
                    document.querySelectorAll('.key-status-btn:not(.main-key-status)').forEach(btn => {
                        if (btn !== button) {
                            btn.dataset.status = 'disabled';
                            btn.dataset.enabled = 'false';
                            btn.style.backgroundColor = '#6c757d';
                            btn.textContent = '⚪';
                            btn.title = '副Key(未启用)';
                        }
                    });
                    break;
                case 'enabled':
                    button.dataset.status = 'failed';
                    button.dataset.enabled = 'false';
                    button.style.backgroundColor = '#dc3545';
                    button.textContent = '🔴';
                    button.title = '副Key标记失败 (点击重新启用)';
                    log('secondaryKeyStatus', '副Key: 启用 → 失败', 'error');
                    break;
                case 'failed':
                    button.dataset.status = 'enabled';
                    button.dataset.enabled = 'true';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = '🟢';
                    button.title = '副Key已启用 (点击禁用)';
                    log('secondaryKeyStatus', '副Key: 失败 → 启用', 'success');
                    // 禁用其他副Key
                    document.querySelectorAll('.key-status-btn:not(.main-key-status)').forEach(btn => {
                        if (btn !== button) {
                            btn.dataset.status = 'disabled';
                            btn.dataset.enabled = 'false';
                            btn.style.backgroundColor = '#6c757d';
                            btn.textContent = '⚪';
                            btn.title = '副Key(未启用)';
                        }
                    });
                    break;
            }
        }

        // 标记主Key为失败
        function testMarkMainKeyFailed() {
            const button = document.querySelector('.main-key-status');
            button.dataset.status = 'failed';
            button.dataset.enabled = 'false';
            button.style.backgroundColor = '#dc3545';
            button.textContent = '🔴';
            button.title = '主Key标记失败 (点击重新启用)';
            log('mainKeyStatus', '主Key被标记为失败状态', 'error');
            log('testLog', '测试标记主Key失败: 成功', 'success');
        }

        // 重置主Key
        function resetMainKey() {
            const button = document.querySelector('.main-key-status');
            button.dataset.status = 'enabled';
            button.dataset.enabled = 'true';
            button.style.backgroundColor = '#28a745';
            button.textContent = '🟢';
            button.title = '主Key已启用 (点击设为失败)';
            log('mainKeyStatus', '主Key已重置为启用状态', 'success');
        }

        // 运行所有测试
        function runAllTests() {
            log('testLog', '开始运行所有测试...', 'info');
            
            // 测试1: 主Key三态切换
            log('testLog', '测试1: 主Key三态切换', 'info');
            const mainBtn = document.querySelector('.main-key-status');
            testMainKeyToggle(mainBtn); // enabled -> failed
            testMainKeyToggle(mainBtn); // failed -> enabled
            
            // 测试2: 副Key启用
            log('testLog', '测试2: 副Key启用', 'info');
            const secondaryBtns = document.querySelectorAll('.key-status-btn:not(.main-key-status)');
            testSecondaryKeyToggle(secondaryBtns[0]); // 启用第一个副Key
            
            // 测试3: 主Key应该自动禁用
            setTimeout(() => {
                const mainStatus = mainBtn.dataset.status;
                if (mainStatus === 'disabled') {
                    log('testLog', '测试3: 副Key启用时主Key自动禁用 - 成功', 'success');
                } else {
                    log('testLog', '测试3: 副Key启用时主Key自动禁用 - 失败', 'error');
                }
            }, 100);
            
            // 测试4: 标记失败
            log('testLog', '测试4: 标记Key失败', 'info');
            testMarkMainKeyFailed();
            
            log('testLog', '所有测试完成！', 'success');
        }

        // 清空日志
        function clearLogs() {
            document.querySelectorAll('.status-log').forEach(log => {
                log.innerHTML = '';
            });
            log('testLog', '日志已清空', 'info');
        }

        // 初始化
        window.onload = function() {
            log('testLog', 'Key状态管理测试页面已加载', 'success');
        };
    </script>
</body>
</html>