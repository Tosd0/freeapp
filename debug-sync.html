<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云同步调试工具</title>
    <script src="config/sync-config.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-size: 12px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔧 云同步调试工具</h1>
    
    <div class="test-section">
        <h3>环境信息</h3>
        <div id="envInfo"></div>
    </div>
    
    <div class="test-section">
        <h3>CORS测试</h3>
        <button onclick="testDirectCors()">测试直接Vercel CORS</button>
        <button onclick="testNetlifyProxy()">测试Netlify代理</button>
        <div id="corsResults"></div>
    </div>
    
    <div class="test-section">
        <h3>API连接测试</h3>
        <button onclick="testApiConnection()">测试API连接</button>
        <div id="apiResults"></div>
    </div>
    
    <div class="test-section">
        <h3>完整同步测试</h3>
        <input type="text" id="testSyncKey" placeholder="输入测试同步密钥" value="debug-test-key">
        <button onclick="testFullSync()">测试完整同步流程</button>
        <div id="syncResults"></div>
    </div>

    <script>
        // 显示环境信息
        function showEnvInfo() {
            const info = {
                hostname: window.location.hostname,
                origin: window.location.origin,
                userAgent: navigator.userAgent.substring(0, 100),
                configuredApiBase: window.SyncConfig ? window.SyncConfig.getApiBaseUrl() : 'SyncConfig not loaded',
                uploadUrl: window.SyncConfig ? window.SyncConfig.getApiUrl('upload') : 'N/A',
                downloadUrl: window.SyncConfig ? window.SyncConfig.getApiUrl('download') : 'N/A'
            };
            
            document.getElementById('envInfo').innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
        }
        
        // 测试直接Vercel CORS
        async function testDirectCors() {
            const resultsDiv = document.getElementById('corsResults');
            resultsDiv.innerHTML += '<div class="info">正在测试直接Vercel CORS...</div>';
            
            try {
                const response = await fetch('https://freeapp-git-sync-tosd0.vercel.app/api/sync/upload', {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                resultsDiv.innerHTML += `<div class="success">✅ 直接CORS测试成功 - 状态: ${response.status}, CORS头: ${corsHeader}</div>`;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">❌ 直接CORS测试失败: ${error.message}</div>`;
            }
        }
        
        // 测试Netlify代理
        async function testNetlifyProxy() {
            const resultsDiv = document.getElementById('corsResults');
            resultsDiv.innerHTML += '<div class="info">正在测试Netlify代理...</div>';
            
            try {
                const response = await fetch('/.netlify/functions/sync-proxy?endpoint=upload', {
                    method: 'OPTIONS'
                });
                
                resultsDiv.innerHTML += `<div class="success">✅ Netlify代理测试成功 - 状态: ${response.status}</div>`;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">❌ Netlify代理测试失败: ${error.message}</div>`;
            }
        }
        
        // 测试API连接
        async function testApiConnection() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<div class="info">正在测试API连接...</div>';
            
            const testUrl = window.SyncConfig ? window.SyncConfig.getApiUrl('manage') : '/api/sync/manage';
            
            try {
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'stats',
                        adminKey: 'test'
                    })
                });
                
                const text = await response.text();
                let result;
                
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    result = { parseError: true, rawResponse: text.substring(0, 300) };
                }
                
                resultsDiv.innerHTML = `
                    <div class="info">API响应状态: ${response.status}</div>
                    <div class="info">响应内容类型: ${response.headers.get('content-type')}</div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">❌ API连接测试失败: ${error.message}</div>`;
            }
        }
        
        // 测试完整同步
        async function testFullSync() {
            const syncKey = document.getElementById('testSyncKey').value;
            const resultsDiv = document.getElementById('syncResults');
            
            if (!syncKey) {
                resultsDiv.innerHTML = '<div class="error">请输入测试同步密钥</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="info">正在测试完整同步流程...</div>';
            
            // 测试数据
            const testData = {
                test: true,
                timestamp: new Date().toISOString(),
                data: { message: "这是测试数据" }
            };
            
            try {
                // 测试上传
                const uploadUrl = window.SyncConfig ? window.SyncConfig.getApiUrl('upload') : '/api/sync/upload';
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        syncKey: syncKey,
                        data: testData
                    })
                });
                
                const uploadResult = await uploadResponse.text();
                resultsDiv.innerHTML += `<div class="info">上传响应 (${uploadResponse.status}):</div><pre>${uploadResult}</pre>`;
                
                if (uploadResponse.ok) {
                    // 测试下载
                    const downloadUrl = window.SyncConfig ? window.SyncConfig.getApiUrl('download') : '/api/sync/download';
                    const downloadResponse = await fetch(downloadUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            syncKey: syncKey
                        })
                    });
                    
                    const downloadResult = await downloadResponse.text();
                    resultsDiv.innerHTML += `<div class="info">下载响应 (${downloadResponse.status}):</div><pre>${downloadResult}</pre>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">❌ 同步测试失败: ${error.message}</div>`;
            }
        }
        
        // 页面加载时显示环境信息
        window.onload = showEnvInfo;
    </script>
</body>
</html>